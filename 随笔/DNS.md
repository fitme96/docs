

## 解决
- 避免内部服务走公网DNS
- 利用缓存加速解析

## 选型
1. Bind9

2. PowerDNS

3. CoreDNS

## 实施Bind9
### 安装
```bash
apt-get install bind9
apt-get install bind9-host dnsutils
```
### 记录日志到文件
```bash
root@sec:/etc/bind# cat named.conf
// This is the primary configuration file for the BIND DNS server named.
//
// Please read /usr/share/doc/bind9/README.Debian.gz for information on the 
// structure of BIND configuration files in Debian, *BEFORE* you customize 
// this configuration file.
//
// If you are just adding zones, please do that in /etc/bind/named.conf.local

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";
logging {
        channel query_log {
                file "query.log." versions 5 size 50m;
                print-time yes;
                severity info;
        };
        category queries { query_log;};
        channel general_log {
                file "general.log." versions 5 size 50m;
                print-time yes;
                print-category yes;
                print-severity yes;
                severity info;
        };
        category default   { general_log; };
        category general   { general_log; };
	    
		// rpz日志
		channel rpzlog {
  			file "rpz.log" versions 5 size 50m;
    		print-time yes;
    		print-category yes;
    		print-severity yes;
    		severity info;
    	};
    	category rpz { rpzlog; };
};
```
### 开启forwarders及允许递归白名单
```bash
root@sec:/etc/bind# cat named.conf.options 
options {
	directory "/var/cache/bind";

	// If there is a firewall between you and nameservers you want
	// to talk to, you may need to fix the firewall to allow multiple
	// ports to talk.  See http://www.kb.cert.org/vuls/id/800113

	// If your ISP provided one or more IP addresses for stable 
	// nameservers, you probably want to use them as forwarders.  
	// Uncomment the following block, and insert the addresses replacing 
	// the all-0's placeholder.

	// forwarders {
	// 	0.0.0.0;
	// };

	//========================================================================
	// If BIND logs error messages about the root key being expired,
	// you will need to update your keys.  See https://www.isc.org/bind-keys
	//========================================================================
	dnssec-validation auto;

	listen-on-v6 { any; };
	version "not currently available";
	recursion yes;
	allow-recursion {0.0.0.0/0;};
	# 减少响应数据
    minimal-responses yes;  
	# 开启rpz
 	response-policy {
    	zone "rpz";
	};
    forwarders {
	    223.5.5.5;
		223.6.6.6;
	};
};


```

### 增加本地域 local和开启rpz
```bash
root@sec:/etc/bind# cat named.conf.local 
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";
zone "local" IN {
    type master;
    file "/etc/bind/local";
};

# rpz
zone "rpz" {
	type master;
	file "/etc/bind/rpz.local";

};
```

```bash
root@sec:/etc/bind# cat local 
$TTL    604800
@       IN      SOA     localhost. root.localhost. (
2         ; Serial
604800         ; Refresh
86400         ; Retry
2419200         ; Expire
604800 )       ; Negative Cache TTL
;
@       IN      NS      localhost.
@       IN      A       127.0.0.1
wiki	IN	A	192.168.230.21
mail	IN	A	192.168.230.22
dd	IN	A	192.168.230.23
www	IN	A	192.168.230.25


root@sec:/etc/bind# cat rpz.local
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL	86400
@	IN	SOA	localhost. root.localhost. (
			      1		; Serial
			 604800		; Refresh
			  86400		; Retry
			2419200		; Expire
			  86400 )	; Negative Cache TTL
;
@	IN	NS	localhost.
docs.seclover.com	A	10.10.101.115
git.seclover.com	A	192.168.230.20
jira.seclover.com	A	192.168.230.20
wiki.seclover.com	A	192.168.230.20 
```

### 检查配置文件语法
```bash
  named-checkconf
  named-checkzone rpz /etc/bind/rpz.local
```
### 重新启动bind9
```bash
  systemctl restart bind9
```
### 测试bind9配置
```bash
 ~  dig @192.168.190.211 mail.local                                                                                ✔  took 10s  at 15:17:22 

; <<>> DiG 9.18.4-2ubuntu2.1-Ubuntu <<>> @192.168.190.211 mail.local
; (1 server found)
;; global options: +cmd
;; Got answer:
;; WARNING: .local is reserved for Multicast DNS
;; You are currently testing what happens when an mDNS query is leaked to DNS
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 34861
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: d0e657d856fe3d5e0100000063f47041ec687073cb37217e (good)
;; QUESTION SECTION:
;mail.local.			IN	A

;; ANSWER SECTION:
mail.local.		604800	IN	A	192.168.230.22

;; Query time: 0 msec
;; SERVER: 192.168.190.211#53(192.168.190.211) (UDP)
;; WHEN: Tue Feb 21 15:18:25 CST 2023
;; MSG SIZE  rcvd: 83



```
## 压测
1. 生成domain.list
```bash 
for i in {1..10000};do echo "www.`head /dev/urandom | tr -dc a-z | head -c 5`.com A" >> domain.list ; done 
```
2. 安装queryperf 
```bash
sudo apt install gcc+ make
wget  wget https://ftp.isc.org/isc/bind9/9.12.4/bind-9.12.4.tar.gz
tar xf bind-9.12.4.tar.gz
cd bind-9.12.4/contrib/queryperf
./configure
make
./queryperf -s 192.168.190.211 -d domain.list -T 10000
```
### 说明
- domain.list中1w条A记录
- -T 指定qps


